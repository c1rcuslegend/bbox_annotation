<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Image Annotation</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='vrg_favicon.ico') }}">

    <script>
        function change(direction) {
            document.getElementById("direction").value = direction;
        }

        function pageSelect(pageNumber) {
            for (let i = 1; i <= 4; i++) {
                document.getElementById("page" + i).classList.toggle('selected', i === pageNumber);
                const divs = document.getElementsByClassName("page" + i + "_element");
                for (const div of divs) {
                    div.style.display = i === pageNumber ? "flex" : "none";
                }
            }
        }

        window.onload = function() {
            const modal = document.getElementById('modal-container');
            const closeModal = document.getElementById('close-modal');

            window.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.remove('show-modal');
                }
            });

            closeModal.addEventListener('click', function() {
                modal.classList.remove('show-modal');
            });

            // Setup uncertainty modal
            const uncertaintyModal = document.getElementById('uncertainty-modal-container');
            const closeUncertaintyModal = document.getElementById('close-uncertainty-modal');

            if (closeUncertaintyModal) {
                closeUncertaintyModal.addEventListener('click', function() {
                    uncertaintyModal.classList.remove('show-modal');
                });
            }

            // Setup buttons for label types
            document.getElementById('none-proposed-btn').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('label_type').value = 'ood';
                document.getElementById('direction').value = 'save';
                
                // Submit the form and navigate back to grid
                const form = document.getElementById('save');
                const formData = new FormData(form);

                fetch(form.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        // Navigate back to grid view after saving
                        window.location.href = `/back2grid/{{ username }}`;
                    } else {
                        console.error('Save failed, but navigating anyway');
                        window.location.href = `/back2grid/{{ username }}`;
                    }
                })
                .catch(error => {
                    console.error('Error saving:', error);
                    window.location.href = `/back2grid/{{ username }}`;
                });
            });

            document.getElementById('not-sure-btn').addEventListener('click', function(e) {
                e.preventDefault();
                uncertaintyModal.classList.add('show-modal');
            });

            // Setup confirm button for uncertainty modal
            document.getElementById('confirm-uncertainty').addEventListener('click', function() {
                const selectedClasses = {};
                const checkboxes = document.querySelectorAll('.uncertainty-class-checkbox:checked');

                checkboxes.forEach(checkbox => {
                    const classId = checkbox.value;
                    const className = checkbox.getAttribute('data-class-name');
                    selectedClasses[classId] = className;
                });

                // Instead of submitting the form immediately, store the selected classes globally.
                window.selectedUncertainClasses = selectedClasses;
                // Set a global flag to indicate uncertainty mode is active.
                window.uncertainty_mode = true;

                // Also update the hidden input to mark the entire image as uncertain.
                document.getElementById('label_type').value = 'uncertain';

                // Hide the uncertainty modal so that the user can now draw the uncertain box.
                document.getElementById('uncertainty-modal-container').classList.remove('show-modal');
            });
        };

        function show_image(img) {
            // Only show modal for images that are not in the bbox container
            if (!img.closest('#image-with-bboxes')) {
                document.getElementById("modal-container").classList.add('show-modal');
                document.getElementById("modal-image").src = img.src;
            }
        }

        /**
         * Search functionality for the uncertainty modal
         */
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('uncertainty-search-input');

            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const classItems = document.querySelectorAll('.uncertainty-class-item');

                    classItems.forEach(item => {
                        const text = item.querySelector('.uncertainty-class-text').textContent.toLowerCase();
                        if (text.includes(searchTerm)) {
                            item.classList.remove('hidden');
                        } else {
                            item.classList.add('hidden');
                        }
                    });
                });
            }
        });

        function saveAndGoBack(username) {
            const form = document.getElementById('save');
            const formData = new FormData(form);

            fetch(form.action, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    window.location.href = `/back2grid/${username}`;
                } else {
                    console.error('Save failed, but navigating anyway');
                    window.location.href = `/back2grid/${username}`;
                }
            })
            .catch(error => {
                console.error('Error saving:', error);
                window.location.href = `/back2grid/${username}`;
            });
        }
    </script>
    <script src="{{ url_for('static', filename='js/bbox-editor.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bbox-editor-ui.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bbox-init.js') }}"></script>
    <script src="{{ url_for('static', filename='js/auto-select-class.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bbox-editor-patch.js') }}"></script>
    <script src="{{ url_for('static', filename='js/inline-bbox-editor.js') }}"></script>
    <script src="{{ url_for('static', filename='js/whole-image-bbox.js') }}"></script>
    <script src="{{ url_for('static', filename='js/refresh-btn.js') }}"></script>
    <script src="{{ url_for('static', filename='js/keyboard-shortcuts.js') }}"></script>
</head>

<body>
    <div class="top-nav">
        <button onclick="saveAndGoBack('{{ username }}')" class="nav-btn back-btn">
            <i class="nav-icon">â—€</i> All images
        </button>
        <div class="title-placeholder"></div>
    </div>

    <div class="row">
        <div class="column-main1 first-column">
            <div class="refresh-btn" onclick="change('prev'); document.getElementById('save').submit();">&#9664;</div>
        </div>

        <div class="image-editor-container">
            <!-- Left column with controls -->
            <div class="image-editor-left">
                <!-- BBox Controls -->
                <div class="bbox-editor-inline">

                    <!-- Box selector -->
                    <div class="control-group">
                        <label for="inline-bbox-selector">Select Box:</label>
                        <select id="inline-bbox-selector" class="editor-selector"></select>
                    </div>

                    <!-- Class selector with search -->
                    <div class="control-group">
                        <label for="inline-class-search">Class:</label>
                        <input type="text" id="inline-class-search" placeholder="Search for class..."
                               class="editor-selector">
                        <select id="inline-class-selector" class="editor-selector"></select>
                    </div>

                    <!-- Crowd of instances checkbox -->
                    <div class="crowd-container">
                        <label for="inline-crowd-checkbox">Crowd of Instances</label>
                        <label class="container">
                            <input type="checkbox" id="inline-crowd-checkbox" name="inline-crowd-checkbox">
                            <div class="checkmark"></div>
                        </label>
                    </div>

                    <!-- Reflected Object checkbox container -->
                    <div class="reflected-container">
                        <label for="inline-reflected-checkbox">Reflected Object</label>
                        <label class="container">
                            <input type="checkbox" id="inline-reflected-checkbox" name="inline-reflected-checkbox">
                            <div class="checkmark checkmark-reflected"></div>
                        </label>
                    </div>

                    <!-- Rendition checkbox container -->
                    <div class="rendition-container">
                        <label for="inline-rendition-checkbox">Rendition</label>
                        <label class="container">
                            <input type="checkbox" id="inline-rendition-checkbox" name="inline-rendition-checkbox">
                            <div class="checkmark checkmark-rendition"></div>
                        </label>
                    </div>

                    <!-- Text based checkbox container -->
                    <div class="ocr-needed-container">
                        <label for="inline-ocr-needed-checkbox">Text based</label>
                        <label class="container">
                            <input type="checkbox" id="inline-ocr-needed-checkbox" name="inline-ocr-needed-checkbox">
                            <div class="checkmark checkmark-ocr-needed"></div>
                        </label>
                    </div>

                    <!-- Show Class Numbers Only checkbox container -->
                    <div class="reflected-container">
                        <label for="inline-class-numbers-checkbox">Simplified Labels</label>
                        <label class="container">
                            <input type="checkbox" id="inline-class-numbers-checkbox" name="inline-class-numbers-checkbox">
                            <div class="checkmark"></div>
                        </label>
                    </div>

                    <!-- Action buttons -->
                    <div class="control-buttons">
                        <button id="inline-bbox-delete" class="editor-button delete-btn">Delete Box</button>
                        <button id="inline-bbox-cancel" class="editor-button cancel-btn">Cancel Changes</button>
                    </div>

                    <div class="control-buttons2">
                        <button id="inline-bbox-delete-all" class="editor-button delete-all-btn">Delete All Boxes</button>
                        <button id="inline-bbox-whole-image" class="editor-button whole-image-btn">Whole Image Box</button>
                    </div>

                    <!-- Open advanced editor button -->
                    <button id="open-popup-editor" class="editor-button popup-btn">
                        Advanced Editor
                    </button>
                </div>

                <!-- Feedback buttons -->
                <div class="comments-container">
                    <div class="feedback-buttons">
                        <button id="not-sure-btn" class="feedback-btn not-sure-btn">Not sure</button>
                        <button id="none-proposed-btn" class="feedback-btn none-proposed-btn">None of ImageNet classes</button>
                    </div>
                </div>
            </div>

            <!-- Right column with image -->
            <div class="image-editor-right">
                <div id="image-with-bboxes" class="enlarged-image-container">
                    <img class="thumbnail-main enlarged-image" src="/{{ predicted_image }}" alt="Input Image">
                </div>

                <!-- Ground truth label -->
                <div class="gt-label">Ground Truth: {{ ground_truth_label|default('Unknown') }}</div>

                <!-- Hidden inputs for form submission -->
                <input form="save" style="display:none;" type="text" name="image_name" value="{{ predicted_image.lstrip('static/images') }}">
                <input id="direction" form="save" style="display:none;" type="text" name="direction" value="save">
            </div>
        </div>

        <div class="column-main1 last-column">
            <div class="refresh-btn" onclick="change('next'); document.getElementById('save').submit();">&#9654;</div>
        </div>
    </div>

    <div class="row">
        <div class="page_number">20 Most likely labels -> </div>
        <div id="page1" class="page_number selected" onclick="pageSelect(1);">1-5</div>
        <div id="page2" class="page_number" onclick="pageSelect(2);">6-10</div>
        <div id="page3" class="page_number" onclick="pageSelect(3);">11-15</div>
        <div id="page4" class="page_number" onclick="pageSelect(4);">16-20</div>
        <div id="refreshExamples" class="page_number refresh-examples">
            <span class="refresh-icon">â†»</span> Refresh
        </div>
    </div>

    <div class="row">
        <p>
            <form id="save" action="{{ url_for('save', username=username) }}" method="post">
                <!-- Hidden inputs for label type and selected classes -->
                <input type="hidden" id="label_type" name="label_type" value="basic">
                <input type="hidden" id="selected_classes" name="selected_classes" value="{}">
            </form>

            {% for pred_info, images in similar_images.items() %}
                {% if loop.index < 21 %}
                    <div class="column
                        {% if loop.index in [5, 10, 15, 20] %}last-column{% endif %}
                        {% if loop.index < 6 %}page1_element{% elif loop.index < 11 %}page2_element
                        {% elif loop.index < 16 %}page3_element{% else %}page4_element{% endif %}">

                        <div class="category_label">{{ human_readable_classes_map[pred_info|string] }}</div>
                        <label class="container">
                            <!-- No more automatic checking based on checked_categories -->
                            <input form="save" type="radio" id="radio_{{ loop.index }}" name="class_selection" value="{{ pred_info }}">
                            <div class="checkmark"></div>
                        </label>
                        <div class="right">
                            {% for img_url in images %}
                                <img class="thumbnail" src="/{{ img_url }}" alt="Class Image" onclick="show_image(this)">
                                {% if loop.index is divisibleby num_similar_images and not loop.last %}
                                {% endif %}
                                    </div><div class="right">
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
    </div>

    <!-- Image Modal -->
    <div id="modal-container" class="modal-container">
        <div id="modal" class="modal">
            <span id="close-modal" class="close-modal">&times;</span> <!-- Close button -->
            <img id="modal-image" class="modal-image">
        </div>
    </div>

    <!-- Uncertainty Modal -->
    <div id="uncertainty-modal-container" class="modal-container">
        <div id="uncertainty-modal" class="modal uncertainty-modal">
            <span id="close-uncertainty-modal" class="close-modal">&times;</span>
            <div class="uncertainty-content">
                <h2>Select Possible Classes</h2>
                <div class="uncertainty-search">
                    <input type="text" id="uncertainty-search-input" placeholder="Search classes...">
                </div>
                <div class="uncertainty-class-list">
                    {% for class_id, class_name in human_readable_classes_map.items() %}
                    <div class="uncertainty-class-item">
                        <label class="uncertainty-class-label">
                            <input type="checkbox" class="uncertainty-class-checkbox" value="{{ class_id }}" data-class-name="{{ class_name }}">
                            <span class="uncertainty-class-text">{{ class_id }} - {{ class_name }}</span>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                <div class="uncertainty-actions">
                    <button id="confirm-uncertainty" class="uncertainty-btn confirm-btn">Confirm Selection</button>
                    <button onclick="document.getElementById('uncertainty-modal-container').classList.remove('show-modal')" class="uncertainty-btn cancel-btn">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- BBox Modal -->
    <div id="bbox-modal-container" class="bbox-editor-modal">
        <div class="bbox-editor-content">
            <span class="bbox-editor-close">&times;</span>
            <div class="bbox-editor-layout">
                <div class="bbox-editor-controls">
                    <h3>Edit Bounding Box</h3>
                    <select id="bbox-selector" class="bbox-editor-selector"></select>

                    <!-- Add class selector dropdown -->
                    <div class="bbox-editor-input-group">
                        <label for="bbox-class-selector">Class:</label>
                        <select id="bbox-class-selector" class="bbox-editor-selector">
                            <!-- Here will be 1000 class options (0-999) -->
                        </select>
                    </div>

                    <div class="bbox-crowd-container">
                        <label for="bbox-crowd-checkbox">Crowd of Instances</label>
                        <label class="container">
                            <input type="checkbox" id="bbox-crowd-checkbox" name="bbox-crowd-checkbox">
                            <div class="checkmark"></div>
                        </label>
                    </div>

                    <div class="bbox-reflected-container">
                        <label for="bbox-reflected-checkbox">Reflected Object</label>
                        <label class="container">
                            <input type="checkbox" id="bbox-reflected-checkbox" name="bbox-reflected-checkbox">
                            <div class="checkmark checkmark-reflected"></div>
                        </label>
                    </div>

                    <div class="bbox-rendition-container">
                        <label for="bbox-rendition-checkbox">Rendition</label>
                        <label class="container">
                            <input type="checkbox" id="bbox-rendition-checkbox" name="bbox-rendition-checkbox">
                            <div class="checkmark checkmark-rendition"></div>
                        </label>
                    </div>

                    <div class="bbox-ocr-needed-container">
                        <label for="bbox-ocr-needed-checkbox">Text based</label>
                        <label class="container">
                            <input type="checkbox" id="bbox-ocr-needed-checkbox" name="bbox-ocr-needed-checkbox">
                            <div class="checkmark checkmark-ocr-needed"></div>
                        </label>
                    </div>

                    <div class="bbox-reflected-container">
                        <label for="bbox-class-numbers-checkbox">Simplified Labels</label>
                        <label class="container">
                            <input type="checkbox" id="bbox-class-numbers-checkbox" name="bbox-class-numbers-checkbox">
                            <div class="checkmark"></div>
                        </label>
                    </div>

                    <div class="bbox-editor-inputs">
                        <div class="bbox-editor-input-group">
                            <label for="bbox-x1">X1</label>
                            <input type="number" id="bbox-x1" min="0">
                        </div>
                        <div class="bbox-editor-input-group">
                            <label for="bbox-y1">Y1</label>
                            <input type="number" id="bbox-y1" min="0">
                        </div>
                        <div class="bbox-editor-input-group">
                            <label for="bbox-x2">X2</label>
                            <input type="number" id="bbox-x2" min="0">
                        </div>
                        <div class="bbox-editor-input-group">
                            <label for="bbox-y2">Y2</label>
                            <input type="number" id="bbox-y2" min="0">
                        </div>
                    </div>
                    <div class="bbox-editor-actions">
                        <button id="bbox-update" class="bbox-editor-button bbox-editor-button-update">Save Changes</button>
                        <button id="bbox-delete" class="bbox-editor-button bbox-editor-button-delete">Delete Box</button>
                        <button id="bbox-delete-all" class="bbox-editor-button bbox-editor-button-delete-all">Delete All Boxes</button>
                        <button id="bbox-whole-image" class="bbox-editor-button whole-image-btn">Whole Image Box</button>
                    </div>
                </div>
                <div class="bbox-editor-preview">
                    <canvas id="bbox-preview-canvas" class="bbox-editor-canvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="refreshSuccess" class="refresh-success">Examples refreshed successfully!</div>

    <!-- Hidden elements for passing data to JavaScript -->
    <div id="ground-truth-data" style="display:none;">{{ ground_truth_class_index|default(0) }}</div>
    <script id="bbox-data" type="application/json">{{ bboxes|tojson }}</script>
    <script id="human-readable-classes" type="application/json">{{ human_readable_classes_map|tojson }}</script>

    <!-- Keyboard Navigation Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Add keyboard event listener for navigation and shortcuts
            document.addEventListener('keydown', function(event) {
                // Only trigger navigation if not typing in an input field (but allow for checkboxes, radio buttons, and images)
                if ((event.target.tagName === 'INPUT' && event.target.type !== 'checkbox' && event.target.type !== 'radio') || 
                    event.target.tagName === 'TEXTAREA' || 
                    (event.target.tagName === 'SELECT' && !event.target.closest('#image-with-bboxes'))) {
                    return;
                }

                // Allow shortcuts to work even when image, canvas, or other image-related elements are focused
                // This ensures shortcuts work after clicking on the image

                // Handle Ctrl key combinations first
                if (event.ctrlKey && !event.altKey) {
                    switch(event.key.toLowerCase()) {
                        case 'g': // Ctrl+G - Toggle Crowd of Instances
                            event.preventDefault();
                            toggleCrowdFlag();
                            break;
                        case 'r': // Ctrl+R - Toggle Reflected Object
                            event.preventDefault();
                            toggleReflectedFlag();
                            break;
                        case 'v': // Ctrl+V - Toggle Rendition flag
                            event.preventDefault();
                            toggleRenditionFlag();
                            break;
                        case 'b': // Ctrl+B - Toggle Text based flag
                            event.preventDefault();
                            toggleOcrNeededFlag();
                            break;
                        case 'x': // Ctrl+X - Delete current bbox
                            event.preventDefault();
                            deleteCurrentBbox();
                            break;
                        case 's': // Ctrl+S - Save changes
                            event.preventDefault();
                            saveChanges();
                            break;
                        case 'a': // Ctrl+A - Create whole image bbox
                            event.preventDefault();
                            createWholeImageBBox();
                            break;
                        case 'z': // Ctrl+Z - Not sure (uncertainty mode) - disabled in advanced editor
                            event.preventDefault();
                            // Check if we're in advanced editor mode
                            const advancedModal = document.getElementById('bbox-modal-container');
                            const isAdvancedMode = advancedModal && advancedModal.classList.contains('show-modal');
                            if (!isAdvancedMode) {
                                activateNotSureMode();
                            }
                            break;
                    }
                    return; // Don't process other keys when Ctrl is pressed
                }
                
                // Handle Ctrl+Alt combinations
                if (event.ctrlKey && event.altKey) {
                    // Ctrl+Alt - Open class selection dropdown for selected bbox
                    event.preventDefault();
                    openClassSelectionDropdown();
                    return;
                }
                
                // Handle Shift key combinations
                if (event.shiftKey) {
                    switch(event.key.toLowerCase()) {
                        case 's': // Shift+S - None of ImageNet classes
                            event.preventDefault();
                            activateNoneOfImageNetMode();
                            break;
                        case 'c': // Shift+C - Copy and paste selected bbox
                            event.preventDefault();
                            copyAndPasteBbox();
                            break;
                    }
                    return; // Don't process other keys when Shift is pressed
                }

                // Left Arrow or 'A' key - Previous
                if (event.key === 'ArrowLeft' || event.key === 'a' || event.key === 'A') {
                    event.preventDefault();
                    change('prev');
                    document.getElementById('save').submit();
                }
                
                // Right Arrow or 'D' key - Next
                else if (event.key === 'ArrowRight' || event.key === 'd' || event.key === 'D') {
                    event.preventDefault();
                    change('next');
                    document.getElementById('save').submit();
                }

                // ESC key - Toggle "All images" button (same as clicking it)
                else if (event.key === 'Escape') {
                    event.preventDefault();
                    saveAndGoBack('{{ username }}');
                }
            });

            // Remove focus from checkboxes and radio buttons after clicking to restore keyboard navigation
            document.addEventListener('click', function(event) {
                if (event.target.tagName === 'INPUT' && 
                    (event.target.type === 'checkbox' || event.target.type === 'radio')) {
                    setTimeout(function() {
                        event.target.blur();
                    }, 50);
                }
                
                // Also remove focus from images and canvas elements to ensure shortcuts work
                if (event.target.tagName === 'IMG' || event.target.tagName === 'CANVAS') {
                    setTimeout(function() {
                        event.target.blur();
                        // Optionally focus on document body to ensure shortcuts work
                        if (document.body) {
                            document.body.focus();
                        }
                    }, 50);
                }
            });
        });

        // Keyboard shortcut handler functions
        function toggleCrowdFlag() {
            // Check if we're in advanced editor mode
            const advancedModal = document.getElementById('bbox-modal-container');
            const isAdvancedMode = advancedModal && advancedModal.classList.contains('show-modal');
            
            if (isAdvancedMode) {
                // Advanced editor mode
                const crowdCheckbox = document.getElementById('bbox-crowd-checkbox');
                if (crowdCheckbox) {
                    crowdCheckbox.checked = !crowdCheckbox.checked;
                    crowdCheckbox.dispatchEvent(new Event('change'));
                    console.log('Toggled crowd flag in advanced mode:', crowdCheckbox.checked);
                } else {
                    console.error('Crowd checkbox not found in advanced editor mode');
                }
            } else {
                // Inline editor mode
                const crowdCheckbox = document.getElementById('inline-crowd-checkbox');
                if (crowdCheckbox) {
                    crowdCheckbox.checked = !crowdCheckbox.checked;
                    crowdCheckbox.dispatchEvent(new Event('change'));
                    console.log('Toggled crowd flag in inline mode:', crowdCheckbox.checked);
                } else {
                    console.error('Crowd checkbox not found in inline editor mode');
                }
            }
        }

        function toggleReflectedFlag() {
            // Check if we're in advanced editor mode
            const advancedModal = document.getElementById('bbox-modal-container');
            const isAdvancedMode = advancedModal && advancedModal.classList.contains('show-modal');
            
            if (isAdvancedMode) {
                // Advanced editor mode
                const reflectedCheckbox = document.getElementById('bbox-reflected-checkbox');
                if (reflectedCheckbox) {
                    reflectedCheckbox.checked = !reflectedCheckbox.checked;
                    reflectedCheckbox.dispatchEvent(new Event('change'));
                    console.log('Toggled reflected flag in advanced mode:', reflectedCheckbox.checked);
                } else {
                    console.error('Reflected checkbox not found in advanced editor mode');
                }
            } else {
                // Inline editor mode
                const reflectedCheckbox = document.getElementById('inline-reflected-checkbox');
                if (reflectedCheckbox) {
                    reflectedCheckbox.checked = !reflectedCheckbox.checked;
                    reflectedCheckbox.dispatchEvent(new Event('change'));
                    console.log('Toggled reflected flag in inline mode:', reflectedCheckbox.checked);
                } else {
                    console.error('Reflected checkbox not found in inline editor mode');
                }
            }
        }

        function toggleRenditionFlag() {
            // Check if we're in advanced editor mode
            const advancedModal = document.getElementById('bbox-modal-container');
            const isAdvancedMode = advancedModal && advancedModal.classList.contains('show-modal');
            
            if (isAdvancedMode) {
                // Advanced editor mode
                const renditionCheckbox = document.getElementById('bbox-rendition-checkbox');
                if (renditionCheckbox) {
                    renditionCheckbox.checked = !renditionCheckbox.checked;
                    renditionCheckbox.dispatchEvent(new Event('change'));
                    console.log('Toggled rendition flag in advanced mode:', renditionCheckbox.checked);
                } else {
                    console.error('Rendition checkbox not found in advanced editor mode');
                }
            } else {
                // Inline editor mode
                const renditionCheckbox = document.getElementById('inline-rendition-checkbox');
                if (renditionCheckbox) {
                    renditionCheckbox.checked = !renditionCheckbox.checked;
                    renditionCheckbox.dispatchEvent(new Event('change'));
                    console.log('Toggled rendition flag in inline mode:', renditionCheckbox.checked);
                } else {
                    console.error('Rendition checkbox not found in inline editor mode');
                }
            }
        }

        function toggleOcrNeededFlag() {
            // Check if we're in advanced editor mode
            const advancedModal = document.getElementById('bbox-modal-container');
            const isAdvancedMode = advancedModal && advancedModal.classList.contains('show-modal');
            
            if (isAdvancedMode) {
                // Advanced editor mode
                const ocrNeededCheckbox = document.getElementById('bbox-ocr-needed-checkbox');
                if (ocrNeededCheckbox) {
                    ocrNeededCheckbox.checked = !ocrNeededCheckbox.checked;
                    ocrNeededCheckbox.dispatchEvent(new Event('change'));
                    console.log('Toggled ocr_needed flag in advanced mode:', ocrNeededCheckbox.checked);
                } else {
                    console.error('OCR needed checkbox not found in advanced editor mode');
                }
            } else {
                // Inline editor mode
                const ocrNeededCheckbox = document.getElementById('inline-ocr-needed-checkbox');
                if (ocrNeededCheckbox) {
                    ocrNeededCheckbox.checked = !ocrNeededCheckbox.checked;
                    ocrNeededCheckbox.dispatchEvent(new Event('change'));
                    console.log('Toggled ocr_needed flag in inline mode:', ocrNeededCheckbox.checked);
                } else {
                    console.error('OCR needed checkbox not found in inline editor mode');
                }
            }
        }

        function deleteCurrentBbox() {
            // Check if we're in advanced editor mode
            const advancedModal = document.getElementById('bbox-modal-container');
            const isAdvancedMode = advancedModal && advancedModal.classList.contains('show-modal');
            
            if (isAdvancedMode) {
                // Advanced editor mode - simply click the delete button
                const deleteBtn = document.getElementById('bbox-delete');
                if (deleteBtn) {
                    deleteBtn.click();
                    console.log('Triggered delete button click in advanced editor mode');
                } else {
                    console.error('Delete button not found in advanced editor mode');
                }
            } else {
                // Inline editor mode
                const deleteBtn = document.getElementById('inline-bbox-delete');
                if (deleteBtn) {
                    deleteBtn.click();
                    console.log('Triggered delete button click in inline editor mode');
                } else {
                    console.error('Delete button not found in inline editor mode');
                }
            }
        }

        function copyAndPasteBbox() {
            // Check if we're in advanced editor mode
            const advancedModal = document.getElementById('bbox-modal-container');
            const isAdvancedMode = advancedModal && advancedModal.classList.contains('show-modal');
            
            let bboxSelector;
            if (isAdvancedMode) {
                // Advanced editor mode
                bboxSelector = document.getElementById('bbox-selector');
                console.log('Advanced mode - bbox selector found:', !!bboxSelector);
            } else {
                // Inline editor mode
                bboxSelector = document.getElementById('inline-bbox-selector');
                console.log('Inline mode - bbox selector found:', !!bboxSelector);
            }
            
            if (!bboxSelector || bboxSelector.value === '' || bboxSelector.value === 'none' || bboxSelector.value === '-1') {
                console.log('No bbox selected for copying');
                return; // No bbox selected
            }

            console.log('Copying bbox with selector value:', bboxSelector.value);

            // Get current bbox data from the appropriate source
            const currentBboxIndex = parseInt(bboxSelector.value);
            let bboxes = null;
            
            if (isAdvancedMode) {
                // In advanced mode, get bboxes from BBoxEditorUI or the editor directly
                if (window.BBoxEditorUI && window.BBoxEditorUI.bboxes) {
                    bboxes = window.BBoxEditorUI.bboxes;
                    console.log('Using BBoxEditorUI.bboxes for advanced mode');
                } else if (window.BBoxEditorUI && window.BBoxEditorUI.editor && window.BBoxEditorUI.editor.bboxes) {
                    bboxes = window.BBoxEditorUI.editor.bboxes;
                    console.log('Using BBoxEditorUI.editor.bboxes for advanced mode');
                } else if (window.bboxEditor && window.bboxEditor.bboxes) {
                    bboxes = window.bboxEditor.bboxes;
                    console.log('Using global bboxEditor.bboxes for advanced mode');
                }
            } else {
                // In inline mode, use the usual sources
                if (window.inlineEditor && window.inlineEditor.bboxes) {
                    bboxes = window.inlineEditor.bboxes;
                    console.log('Using inlineEditor.bboxes');
                } else if (window.bboxEditor && window.bboxEditor.bboxes) {
                    bboxes = window.bboxEditor.bboxes;
                    console.log('Using bboxEditor.bboxes');
                } else if (window.bboxes) {
                    bboxes = window.bboxes;
                    console.log('Using global window.bboxes');
                }
            }

            if (!bboxes || !bboxes.boxes || isNaN(currentBboxIndex) || !bboxes.boxes[currentBboxIndex]) {
                console.error('Cannot find bbox data for copying', {
                    bboxes: !!bboxes,
                    boxes: bboxes ? !!bboxes.boxes : false,
                    currentBboxIndex: currentBboxIndex,
                    isValidIndex: bboxes && bboxes.boxes ? currentBboxIndex < bboxes.boxes.length : false
                });
                return;
            }

            // Get the current bbox data
            const currentBox = bboxes.boxes[currentBboxIndex];
            const currentLabel = bboxes.labels && bboxes.labels[currentBboxIndex] !== undefined ? bboxes.labels[currentBboxIndex] : 0;
            const currentCrowdFlag = bboxes.crowd_flags && bboxes.crowd_flags[currentBboxIndex] !== undefined ? bboxes.crowd_flags[currentBboxIndex] : false;
            const currentReflectedFlag = bboxes.reflected_flags && bboxes.reflected_flags[currentBboxIndex] !== undefined ? bboxes.reflected_flags[currentBboxIndex] : false;
            const currentRenditionFlag = bboxes.rendition_flags && bboxes.rendition_flags[currentBboxIndex] !== undefined ? bboxes.rendition_flags[currentBboxIndex] : false;
            const currentOcrNeededFlag = bboxes.ocr_needed_flags && bboxes.ocr_needed_flags[currentBboxIndex] !== undefined ? bboxes.ocr_needed_flags[currentBboxIndex] : false;
            const currentUncertainFlag = bboxes.uncertain_flags && bboxes.uncertain_flags[currentBboxIndex] !== undefined ? bboxes.uncertain_flags[currentBboxIndex] : false;
            const currentPossibleLabels = bboxes.possible_labels && bboxes.possible_labels[currentBboxIndex] ? bboxes.possible_labels[currentBboxIndex] : [];

            // Initialize arrays if they don't exist
            if (!bboxes.boxes) bboxes.boxes = [];
            if (!bboxes.scores) bboxes.scores = [];
            if (!bboxes.labels) bboxes.labels = [];
            if (!bboxes.crowd_flags) bboxes.crowd_flags = [];
            if (!bboxes.reflected_flags) bboxes.reflected_flags = [];
            if (!bboxes.rendition_flags) bboxes.rendition_flags = [];
            if (!bboxes.ocr_needed_flags) bboxes.ocr_needed_flags = [];
            if (!bboxes.uncertain_flags) bboxes.uncertain_flags = [];
            if (!bboxes.possible_labels) bboxes.possible_labels = [];

            // Ensure all flag arrays have the correct length before adding new values
            const currentLength = bboxes.boxes.length;
            while (bboxes.crowd_flags.length < currentLength) {
                bboxes.crowd_flags.push(false);
            }
            while (bboxes.reflected_flags.length < currentLength) {
                bboxes.reflected_flags.push(false);
            }
            while (bboxes.rendition_flags.length < currentLength) {
                bboxes.rendition_flags.push(false);
            }
            while (bboxes.ocr_needed_flags.length < currentLength) {
                bboxes.ocr_needed_flags.push(false);
            }
            while (bboxes.uncertain_flags.length < currentLength) {
                bboxes.uncertain_flags.push(false);
            }
            while (bboxes.possible_labels.length < currentLength) {
                bboxes.possible_labels.push([]);
            }
            while (bboxes.labels.length < currentLength) {
                bboxes.labels.push(0);
            }

            // Store the index before adding the new box
            const newBoxIndex = bboxes.boxes.length;

            // Add the exact copy of the bbox
            bboxes.boxes.push([...currentBox]); // Use array copy
            bboxes.scores.push(100); // Default score
            bboxes.labels.push(currentLabel);
            bboxes.crowd_flags.push(currentCrowdFlag);
            bboxes.reflected_flags.push(currentReflectedFlag);
            bboxes.rendition_flags.push(currentRenditionFlag);
            bboxes.ocr_needed_flags.push(currentOcrNeededFlag);
            bboxes.uncertain_flags.push(currentUncertainFlag);
            bboxes.possible_labels.push([...currentPossibleLabels]); // Copy possible labels

            // Also update gt field if it exists
            if (bboxes.gt) {
                // Ensure gt array has correct length
                while (bboxes.gt.length < newBoxIndex) {
                    bboxes.gt.push(0);
                }
                bboxes.gt.push(currentLabel);
            }

            console.log(`Copied bbox: [${currentBox.join(', ')}] with label ${currentLabel}`);

            if (isAdvancedMode) {
                // For advanced mode, update the BBoxEditorUI state directly
                if (window.BBoxEditorUI) {
                    window.BBoxEditorUI.bboxes = bboxes;
                    window.BBoxEditorUI.currentBoxIndex = newBoxIndex;
                    window.BBoxEditorUI.selectedIndex = newBoxIndex;
                    
                    // Update the editor reference if available
                    if (window.BBoxEditorUI.editor) {
                        window.BBoxEditorUI.editor.bboxes = bboxes;
                        window.BBoxEditorUI.editor.selectedBboxIndex = newBoxIndex;
                        window.BBoxEditorUI.editor.redrawCanvas();
                    }
                    
                    // Update the bbox selector dropdown and trigger UI update
                    window.BBoxEditorUI.updateBboxSelector(bboxes, newBoxIndex, window.BBoxEditorUI.editor ? window.BBoxEditorUI.editor.classLabels : {});
                    
                    // Update the form fields to show the new bbox
                    window.BBoxEditorUI.updateBoxValues(bboxes.boxes[newBoxIndex]);
                    
                    // Update checkboxes
                    window.BBoxEditorUI.updateCrowdCheckbox(newBoxIndex);
                    window.BBoxEditorUI.updateReflectedCheckbox(newBoxIndex);
                    window.BBoxEditorUI.updateRenditionCheckbox(newBoxIndex);
                    window.BBoxEditorUI.updateOcrNeededCheckbox(newBoxIndex);
                    
                    // Update the preview canvas
                    window.BBoxEditorUI.updatePreviewCanvas();
                    
                    // Set the bbox selector to the new bbox
                    const advancedBboxSelector = document.getElementById('bbox-selector');
                    if (advancedBboxSelector) {
                        advancedBboxSelector.value = newBoxIndex.toString();
                        advancedBboxSelector.dispatchEvent(new Event('change'));
                    }
                    
                    console.log('Updated advanced editor UI with new copied bbox');
                }
            } else {
                // For inline mode, use the existing logic
                // Update the inline editor's state
                if (window.inlineEditor) {
                    window.inlineEditor.bboxes = bboxes;
                    window.inlineEditor.currentBoxIndex = newBoxIndex;

                    // If the editor is connected, update it too
                    if (window.inlineEditor.editor) {
                        window.inlineEditor.editor.bboxes = bboxes;
                        window.inlineEditor.editor.selectedBboxIndex = newBoxIndex;
                        window.inlineEditor.editor.redrawCanvas();
                    }
                }

                // Update the bbox editor if it exists
                if (window.bboxEditor) {
                    window.bboxEditor.bboxes = bboxes;
                    window.bboxEditor.selectedBboxIndex = newBoxIndex;
                    window.bboxEditor.redrawCanvas();
                }

                // Update inline editor selector
                const inlineBboxSelector = document.getElementById('inline-bbox-selector');
                if (inlineBboxSelector) {
                    // Store current option texts to preserve them
                    const existingOptions = {};
                    for (let i = 0; i < inlineBboxSelector.options.length; i++) {
                        const option = inlineBboxSelector.options[i];
                        if (option.value !== "-1") {
                            existingOptions[option.value] = option.textContent;
                        }
                    }

                    // Clear and rebuild options
                    while (inlineBboxSelector.options.length > 0) {
                        inlineBboxSelector.remove(0);
                    }

                    // Add default option
                    const defaultOption = document.createElement('option');
                    defaultOption.value = "-1";
                    defaultOption.textContent = "Select a box...";
                    inlineBboxSelector.appendChild(defaultOption);

                    // Add options for each bbox, preserving existing names
                    for (let i = 0; i < bboxes.boxes.length; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        
                        // Use existing name if available, otherwise create new name
                        if (existingOptions[i]) {
                            option.textContent = existingOptions[i];
                        } else {
                            // This is the new copied bbox
                            option.textContent = `BBox ${i + 1} (Copy)`;
                        }
                        
                        inlineBboxSelector.appendChild(option);
                    }

                    // Select the new bbox
                    inlineBboxSelector.value = newBoxIndex;

                    // Trigger change event to update the inline editor
                    inlineBboxSelector.dispatchEvent(new Event('change'));
                }
            }

            // Update the hidden bboxes field if it exists
            const bboxesField = document.getElementById('bboxes-data-field');
            if (bboxesField) {
                let bboxDataArray = [];
                bboxes.boxes.forEach((box, i) => {
                    const isUncertain = (bboxes.uncertain_flags && bboxes.uncertain_flags[i]) ||
                                       (bboxes.labels && bboxes.labels[i] === -1);

                    let bboxData = {
                        coordinates: box,
                        crowd_flag: bboxes.crowd_flags && bboxes.crowd_flags[i],
                        reflected_flag: bboxes.reflected_flags && bboxes.reflected_flags[i],
                        rendition_flag: bboxes.rendition_flags && bboxes.rendition_flags[i],
                        ocr_needed_flag: bboxes.ocr_needed_flags && bboxes.ocr_needed_flags[i]
                    };

                    if (isUncertain) {
                        bboxData.uncertain_flag = true;
                        bboxData.possible_labels = bboxes.possible_labels && bboxes.possible_labels[i] ?
                            bboxes.possible_labels[i] : [];
                        bboxData.label = -1;
                    } else {
                        bboxData.label = bboxes.labels && bboxes.labels[i] !== undefined ?
                            bboxes.labels[i] : 0;
                    }

                    bboxDataArray.push(bboxData);
                });

                const labelType = document.getElementById('label_type')?.value || "basic";
                const formData = {
                    bboxes: bboxDataArray,
                    label_type: labelType
                };

                bboxesField.value = JSON.stringify(formData);
            }

            // Update the bbox data element
            const bboxDataElem = document.getElementById('bbox-data');
            if (bboxDataElem) {
                bboxDataElem.textContent = JSON.stringify(bboxes);
            }

            // Call the refresh function if it exists
            if (window.refreshInlineEditor) {
                window.refreshInlineEditor();
            }
        }

        function saveChanges() {
            // Ensure bbox data is updated before saving
            if (window.updateHiddenBboxesField && typeof window.updateHiddenBboxesField === 'function') {
                window.updateHiddenBboxesField();
            }
            
            // Set direction to save
            document.getElementById('direction').value = 'save';
            document.getElementById('save').submit();
        }

        function activateNotSureMode() {
            const notSureBtn = document.getElementById('not-sure-btn');
            if (notSureBtn) {
                notSureBtn.click();
            }
        }

        function activateNoneOfImageNetMode() {
            const noneProposedBtn = document.getElementById('none-proposed-btn');
            if (noneProposedBtn) {
                noneProposedBtn.click();
            }
        }

        function openClassSelectionDropdown() {
            // Check if we're in advanced editor mode
            const advancedModal = document.getElementById('bbox-modal-container');
            const isAdvancedMode = advancedModal && advancedModal.classList.contains('show-modal');
            
            if (isAdvancedMode) {
                // Advanced editor mode - try to open the dropdown
                const classSearchInput = document.getElementById('class-search-input');
                if (classSearchInput && !classSearchInput.disabled) {
                    // Focus the input field first
                    classSearchInput.focus();
                    classSearchInput.select();
                    
                    // Try to trigger the dropdown by simulating a click
                    const clickEvent = new MouseEvent('click', {
                        view: window,
                        bubbles: true,
                        cancelable: true
                    });
                    classSearchInput.dispatchEvent(clickEvent);
                    
                    console.log('Opened class selection dropdown in advanced mode');
                    showKeyboardShortcutFeedback('Class dropdown opened (Ctrl+Alt)');
                } else {
                    console.log('Class selection input not available in advanced mode (may be disabled for Not Sure box)');
                    showKeyboardShortcutFeedback('No bbox selected or Not Sure mode active');
                }
            } else {
                // Inline editor mode - focus and activate the class search dropdown
                const inlineClassSearch = document.getElementById('inline-class-search');
                if (inlineClassSearch) {
                    // Check if a bbox is selected first
                    const inlineBboxSelector = document.getElementById('inline-bbox-selector');
                    if (!inlineBboxSelector || inlineBboxSelector.value === '' || inlineBboxSelector.value === '-1') {
                        console.log('No bbox selected for class dropdown');
                        showKeyboardShortcutFeedback('Please select a bounding box first');
                        return;
                    }
                    
                    if (!inlineClassSearch.disabled) {
                        // Focus the input field and select its contents
                        inlineClassSearch.focus();
                        inlineClassSearch.select();
                        
                        // Try to trigger the dropdown by simulating a click
                        const clickEvent = new MouseEvent('click', {
                            view: window,
                            bubbles: true,
                            cancelable: true
                        });
                        inlineClassSearch.dispatchEvent(clickEvent);
                        
                        console.log('Opened class selection dropdown in inline mode');
                        showKeyboardShortcutFeedback('Class dropdown opened (Ctrl+Alt)');
                    } else {
                        console.log('Class selection input disabled (may be Not Sure mode)');
                        showKeyboardShortcutFeedback('Not Sure mode active - cannot change class');
                    }
                } else {
                    console.error('Inline class search input not found');
                    showKeyboardShortcutFeedback('Class selector not available');
                }
            }
        }

        // Note: createWholeImageBBox function is already defined in whole-image-bbox.js

        // Visual feedback function for keyboard shortcuts
        function showKeyboardShortcutFeedback(message) {
            // Create or reuse existing feedback element
            let feedbackElement = document.getElementById('keyboard-shortcut-feedback');
            if (!feedbackElement) {
                feedbackElement = document.createElement('div');
                feedbackElement.id = 'keyboard-shortcut-feedback';
                feedbackElement.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: rgba(40, 167, 69, 0.9);
                    color: white;
                    padding: 8px 16px;
                    border-radius: 4px;
                    font-size: 12px;
                    font-weight: bold;
                    z-index: 10000;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                    pointer-events: none;
                `;
                document.body.appendChild(feedbackElement);
            }

            feedbackElement.textContent = message;
            feedbackElement.style.opacity = '1';
            
            // Clear any existing timeout
            if (feedbackElement.fadeTimeout) {
                clearTimeout(feedbackElement.fadeTimeout);
            }
            
            // Hide after 2 seconds
            feedbackElement.fadeTimeout = setTimeout(() => {
                feedbackElement.style.opacity = '0';
            }, 2000);
        }

        // Update all keyboard shortcut functions to show feedback
        const originalToggleCrowdFlag = toggleCrowdFlag;
        toggleCrowdFlag = function() {
            originalToggleCrowdFlag();
            showKeyboardShortcutFeedback('Crowd Flag Toggled (Ctrl+G)');
        };

        const originalToggleReflectedFlag = toggleReflectedFlag;
        toggleReflectedFlag = function() {
            originalToggleReflectedFlag();
            showKeyboardShortcutFeedback('Reflected Flag Toggled (Ctrl+R)');
        };

        const originalToggleRenditionFlag = toggleRenditionFlag;
        toggleRenditionFlag = function() {
            originalToggleRenditionFlag();
            showKeyboardShortcutFeedback('Rendition Flag Toggled (Ctrl+V)');
        };

        const originalToggleOcrNeededFlag = toggleOcrNeededFlag;
        toggleOcrNeededFlag = function() {
            originalToggleOcrNeededFlag();
            showKeyboardShortcutFeedback('Text based Flag Toggled (Ctrl+B)');
        };

        const originalDeleteCurrentBbox = deleteCurrentBbox;
        deleteCurrentBbox = function() {
            originalDeleteCurrentBbox();
            showKeyboardShortcutFeedback('BBox Deleted (Ctrl+X)');
        };

        const originalCopyAndPasteBbox = copyAndPasteBbox;
        copyAndPasteBbox = function() {
            originalCopyAndPasteBbox();
            showKeyboardShortcutFeedback('BBox Copied & Pasted (Shift+C)');
        };

        const originalSaveChanges = saveChanges;
        saveChanges = function() {
            originalSaveChanges();
            showKeyboardShortcutFeedback('Changes Saved (Ctrl+S)');
        };

        const originalActivateNotSureMode = activateNotSureMode;
        activateNotSureMode = function() {
            // Check if we're in advanced editor mode
            const advancedModal = document.getElementById('bbox-modal-container');
            const isAdvancedMode = advancedModal && advancedModal.classList.contains('show-modal');
            if (!isAdvancedMode) {
                originalActivateNotSureMode();
                showKeyboardShortcutFeedback('Not Sure Mode (Ctrl+Z)');
            }
        };

        const originalActivateNoneOfImageNetMode = activateNoneOfImageNetMode;
        activateNoneOfImageNetMode = function() {
            originalActivateNoneOfImageNetMode();
            showKeyboardShortcutFeedback('None of ImageNet Mode (Shift+S)');
        };

        // Add feedback for Ctrl+A (whole image bbox)
        window.originalCreateWholeImageBBox = window.createWholeImageBBox;
        window.createWholeImageBBox = function() {
            console.log('createWholeImageBBox called via keyboard shortcut');
            
            // Always call the original function - it will detect the mode internally
            if (window.originalCreateWholeImageBBox) {
                window.originalCreateWholeImageBBox();
            }
            
            showKeyboardShortcutFeedback('Whole Image BBox Created (Ctrl+A)');
        };
    </script>
</body>
</html>